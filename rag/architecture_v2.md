# RAG Service QuickWin - Solution Design Document

**Version:** 4.1.0  
**Last Updated:** 2025-01-27  
**Author:** Solution Architect Team

---

## Table of Contents

- [RAG Service QuickWin - Solution Design Document](#rag-service-quickwin---solution-design-document)
  - [Table of Contents](#table-of-contents)
  - [1. Executive Summary](#1-executive-summary)
    - [Design Principles](#design-principles)
    - [Key Features](#key-features)
  - [2. High-Level Architecture](#2-high-level-architecture)
  - [3. Core Components](#3-core-components)
    - [3.1 API Gateway](#31-api-gateway)
      - [3.1.2. Data type routing](#312-data-type-routing)
    - [3.2 Processing Services](#32-processing-services)
    - [3.3 Queue Architecture](#33-queue-architecture)
      - [MÃ´ táº£ luá»“ng:](#mÃ´-táº£-luá»“ng)
    - [3.4 Key Design Decisions](#34-key-design-decisions)
  - [4. Document Upload Flow](#4-document-upload-flow)
    - [4.1 Design Decisions](#41-design-decisions)
    - [4.2 Upload Flow Diagram](#42-upload-flow-diagram)
    - [4.3 Upload Case Handling](#43-upload-case-handling)
    - [4.4 Conflict Resolution Options](#44-conflict-resolution-options)
    - [4.5 Soft Delete \& Restore](#45-soft-delete--restore)
  - [5. Pipeline Configuration](#5-pipeline-configuration)
    - [5.1 Ingestion Pipeline Configuration](#51-ingestion-pipeline-configuration)
    - [5.2 Retrieval Pipeline Configuration](#52-retrieval-pipeline-configuration)
  - [6. Storage Architecture](#6-storage-architecture)
  - [7. Data Models \& Database Schema](#7-data-models--database-schema)
    - [7.1 User Management Tables](#71-user-management-tables)
    - [7.2 RAG Data Tables](#72-rag-data-tables)
    - [7.3 Pipeline Tables](#73-pipeline-tables)
  - [8. Ingestion Pipeline Flow](#8-ingestion-pipeline-flow)
  - [9. Retrieval Pipeline Flow](#9-retrieval-pipeline-flow)
  - [10. Permission Model](#10-permission-model)
    - [10.1 Roles](#101-roles)
    - [10.2 Query-Time Filter](#102-query-time-filter)
      - [KB Level](#kb-level)
      - [Document Level (Inherit)](#document-level-inherit)
    - [ğŸ”„ Permission Filter Flow (ÄÆ¡n giáº£n hÃ³a)](#-permission-filter-flow-Ä‘Æ¡n-giáº£n-hÃ³a)
  - [11. API Design](#11-api-design)
    - [11.1 Document APIs](#111-document-apis)
    - [11.2 Query APIs](#112-query-apis)
  - [12. Technology Stack](#12-technology-stack)
  - [13. Deployment Architecture](#13-deployment-architecture)
  - [14. Implementation Roadmap](#14-implementation-roadmap)

---

## 1. Executive Summary

RAG Service QuickWin lÃ  má»™t **No-Code RAG Platform** cho phÃ©p ngÆ°á»i dÃ¹ng doanh nghiá»‡p - Ä‘áº·c biá»‡t lÃ  nhá»¯ng ngÆ°á»i **khÃ´ng cÃ³ background ká»¹ thuáº­t** - cÃ³ thá»ƒ tá»± xÃ¢y dá»±ng vÃ  váº­n hÃ nh má»™t há»‡ thá»‘ng RAG hoÃ n chá»‰nh chá»‰ thÃ´ng qua giao diá»‡n cáº¥u hÃ¬nh trá»±c quan.

### Design Principles

| Principle | Description |
|-----------|-------------|
| **No-Code First** | NgÆ°á»i dÃ¹ng non-technical cÃ³ thá»ƒ tá»± build pipeline |
| **Simplicity** | Config tá»‘i thiá»ƒu, auto-detect khi cÃ³ thá»ƒ |
| **Multi data types processing** | Cho phÃ©p táº¡o dynamic pipeline Ä‘á»ƒ adapt vá»›i nhiá»u loáº¡i data |

### Key Features

| Feature | Description |
|---------|-------------|
| **No-Code Pipeline Builder** | XÃ¢y dá»±ng RAG pipeline chá»‰ báº±ng UI config, khÃ´ng cáº§n viáº¿t code |
| **RBAC** | Role-Based Access Control Ä‘áº§y Ä‘á»§ (Admin, Tenant Admin, KB Manager, Contributor, Viewer) |
| **Multi-Type Support** | Há»— trá»£ PDF, Excel, Word, Image, Audio, HTML - tá»± Ä‘á»™ng detect vÃ  parse |
| **Hybrid Search** | Vector (Milvus) + Fulltext (Elasticsearch) vá»›i weight tuá»³ chá»‰nh |
| **Document Management** | Upload vá»›i conflict handling, soft delete, restore tá»« Trash |
| **Fine-grained Permissions** | PhÃ¢n quyá»n á»Ÿ má»©c Document vÃ  Knowledge Base |

---

## 2. High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           RAG SERVICE QUICKWIN                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                            User Interface                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚   Upload     â”‚  â”‚  Configure   â”‚  â”‚    Query     â”‚  â”‚    Trash     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  Documents   â”‚  â”‚  Pipelines   â”‚  â”‚   Interface  â”‚  â”‚   Manager    â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚                                            â”‚
â”‚                                     â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                           API Gateway                                     â”‚   â”‚
â”‚  â”‚                    (Auth, Rate Limit, Routing)                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚                                            â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚         â–¼                           â–¼                           â–¼               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚    Upload       â”‚      â”‚    Push to      â”‚      â”‚   Management    â”‚         â”‚
â”‚  â”‚   Middleware    â”‚      â”‚     Queue       â”‚      â”‚    Service      â”‚         â”‚
â”‚  â”‚                 â”‚      â”‚                 â”‚      â”‚                 â”‚         â”‚
â”‚  â”‚ â€¢ Validate      â”‚      â”‚                 â”‚      â”‚ â€¢ User/Group    â”‚         â”‚
â”‚  â”‚ â€¢ Check conflictâ”‚      â”‚                 â”‚      â”‚ â€¢ KB CRUD       â”‚         â”‚
â”‚  â”‚ â€¢ Store MinIO   â”‚      â”‚                 â”‚      â”‚ â€¢ Pipeline cfg  â”‚         â”‚
â”‚  â”‚                 â”‚      â”‚                 â”‚      â”‚ â€¢ Permissions   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚           â”‚                        â”‚                                             â”‚
â”‚           â–¼                        â–¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      Message Queue (Redis)                                â”‚   â”‚
â”‚  â”‚                                                                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚   â”‚
â”‚  â”‚  â”‚     Ingestion Queue        â”‚    â”‚     Retrieval Queue        â”‚        â”‚   â”‚
â”‚  â”‚  â”‚                            â”‚    â”‚                            â”‚        â”‚   â”‚
â”‚  â”‚  â”‚  Request contains:         â”‚    â”‚  Request contains:         â”‚        â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ document_ids            â”‚    â”‚  â€¢ query                   â”‚        â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ pipeline_config         â”‚    â”‚  â€¢ pipeline_config         â”‚        â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ kb_id                   â”‚    â”‚  â€¢ kb_id                   â”‚        â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ user_context            â”‚    â”‚  â€¢ user_context            â”‚        â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                                    â”‚                                â”‚
â”‚           â–¼                                    â–¼                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚      Ingestion Worker         â”‚   â”‚      Retrieval Worker         â”‚         â”‚
â”‚  â”‚      (Auto-scale)             â”‚   â”‚      (Auto-scale)             â”‚         â”‚
â”‚  â”‚                               â”‚   â”‚                               â”‚         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚
â”‚  â”‚  â”‚ 1. Parser Service       â”‚  â”‚   â”‚  â”‚ 1. Query Processor      â”‚  â”‚         â”‚
â”‚  â”‚  â”‚    (Extract content)    â”‚  â”‚   â”‚  â”‚    (Optiona l)          â”‚  â”‚         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚
â”‚  â”‚              â–¼                â”‚   â”‚              â–¼                â”‚         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚
â”‚  â”‚  â”‚ 2. Content Router       â”‚  â”‚   â”‚  â”‚ 2. Embedder Service     â”‚  â”‚         â”‚
â”‚  â”‚  â”‚    (Detect content type)â”‚  â”‚   â”‚  â”‚    (Query vector)       â”‚  â”‚         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚
â”‚  â”‚        â”‚       â”‚       â”‚      â”‚   â”‚              â–¼                â”‚         â”‚
â”‚  â”‚        â–¼       â–¼       â–¼      â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚  â”‚ 3. Searcher Service     â”‚  â”‚         â”‚
â”‚  â”‚  â”‚ 3. Chunker Service      â”‚  â”‚   â”‚  â”‚    (Milvus + ES + RRF)  â”‚  â”‚         â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â” â”‚  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚
â”‚  â”‚  â”‚  â”‚Unstru-â”‚Struc- â”‚Codeâ”‚ â”‚  â”‚   â”‚              â–¼                â”‚         â”‚
â”‚  â”‚  â”‚  â”‚ctured â”‚tured  â”‚AST â”‚ â”‚  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜ â”‚  â”‚   â”‚  â”‚ 4. Reranker Service     â”‚  â”‚         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚  â”‚    (Optional)           â”‚  â”‚         â”‚
â”‚  â”‚              â–¼                â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚              â–¼                â”‚         â”‚
â”‚  â”‚  â”‚ 4. Embedder Service     â”‚  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚
â”‚  â”‚  â”‚    (Same for all types) â”‚  â”‚   â”‚  â”‚ 5. LLM Service          â”‚  â”‚         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚  â”‚    (Generate answer)    â”‚  â”‚         â”‚
â”‚  â”‚              â–¼                â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚                               â”‚         â”‚
â”‚  â”‚  â”‚ 5. Indexer Service      â”‚  â”‚   â”‚                               â”‚         â”‚
â”‚  â”‚  â”‚    (Milvus + ES)        â”‚  â”‚   â”‚                               â”‚         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚                               â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                  â”‚                                   â”‚                          â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                    â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         Processing Services                               â”‚   â”‚
â”‚  â”‚                                                                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  Parser   â”‚ â”‚  Chunker  â”‚ â”‚  Embedder â”‚ â”‚  Indexer  â”‚ â”‚  Searcher â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  Service  â”‚ â”‚  Service  â”‚ â”‚  Service  â”‚ â”‚  Service  â”‚ â”‚  Service  â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚   â”‚
â”‚  â”‚  â”‚  Query    â”‚ â”‚  Reranker â”‚ â”‚    LLM    â”‚ â”‚  Content  â”‚               â”‚   â”‚
â”‚  â”‚  â”‚ Processor â”‚ â”‚  Service  â”‚ â”‚  Service  â”‚ â”‚  Router   â”‚               â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚                                            â”‚
â”‚                                     â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                            Data Layer                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚   â”‚
â”‚  â”‚  â”‚  MinIO    â”‚  â”‚PostgreSQL â”‚  â”‚  Milvus   â”‚  â”‚  Elastic  â”‚             â”‚   â”‚
â”‚  â”‚  â”‚  (Files)  â”‚  â”‚ (Metadata)â”‚  â”‚ (Vector)  â”‚  â”‚  (Text)   â”‚             â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Core Components

### 3.1 API Gateway

| Service | Type | Responsibility |
|---------|------|----------------|
| **Push to MinIO** | API | Validate files, check conflicts, store object to MinIO and metadata to db |
| **Push to Queue** | API | Push request to correct queue (Ingestion/Retrieval) |
| **Management Service** | API | User/Group management, KB CRUD, Pipeline config, Permissions |

#### 3.1.2. Data type routing
(*Used when user upload data in multiple types*)
| Service | Type | Responsibility |
|---------|------|----------------|
| **Category input data** | Hard code | Based on file types, category them into same group for apply chunking strategies better|

### 3.2 Processing Services

| Service | Input | Output | Called By |
|---------|-------|--------|-----------|
| **Parser Service** | File path (MinIO) | Extracted text | Ingestion Worker |
| **Chunker Service** | Text + Config | Chunks | Ingestion Worker |
| **Embedder Service** | Chunks + Model config | Vectors | Ingestion Worker / Retrieval Worker |
| **Indexer Service** | Chunks + Vectors | Indexed in Milvus/ES | Ingestion Worker |
| **Query Processor** | Query + Config | Processed query | Retrieval Worker |
| **Searcher Service** | Query + Config | Search results | Retrieval Worker |
| **Reranker Service** | Results + Config | Reranked results | Retrieval Worker |
| **LLM Service** | Context + Query | Generated answer | Retrieval Worker |

### 3.3 Queue Architecture
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User    â”‚ â”€â”€â”€â”€ â”‚   API   â”‚ â”€â”€â”€â”€ â”‚   DB    â”‚      â”‚  Worker  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚                                  â”‚
                       â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  Queue  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### MÃ´ táº£ luá»“ng:

Request cá»§a ngÆ°á»i dÃ¹ng sáº½ Ä‘Æ°á»£c Ä‘áº©y vÃ o queue vá»›i request_id vÃ  status = pending

**1. User gá»­i request:**

| Component | Action |
|-----------|--------|
| API | Táº¡o record trong DB vá»›i status = `"pending"` |
| API | Push chá»‰ `request_id` vÃ o queue |
| API | Return thÃ´ng bÃ¡o táº¡o request bot Ä‘Æ°á»£c gá»­i thÃ nh cÃ´ng |

**2. User cancel:**

| Component | Action |
|-----------|--------|
| API | Update DB: status = `"cancelled"` |
| API | Done (khÃ´ng cáº§n xÃ³a message trong queue) |

**3. Worker xá»­ lÃ½:**

| Component | Action |
|-----------|--------|
| Worker | Nháº­n `request_id` tá»« queue |
| Worker | Query DB láº¥y request + status |
| Worker | IF status == `"cancelled"` â†’ skip, ack message |
| Worker | IF status == `"pending"` â†’ update status = `"processing"` â†’ xá»­ lÃ½ â†’ update status = `"completed"` |

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           QUEUE ARCHITECTURE                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  KEY DESIGN: 2 Queues Only, Config in Request, Sequential Service Calls         â”‚
â”‚                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                        INGESTION QUEUE                                   â”‚    â”‚
â”‚  â”‚                                                                          â”‚    â”‚
â”‚  â”‚  Request Message:                                                        â”‚    â”‚
â”‚  â”‚  {                                                                       â”‚    â”‚
â”‚  â”‚    "request_id": "request_001",                                          â”‚    â”‚
â”‚  â”‚    "document_ids": ["doc_hash_1", "doc_hash_2"],                        â”‚    â”‚
â”‚  â”‚    "kb_id": "kb_001",                                                    â”‚    â”‚
â”‚  â”‚    "pipeline_config": "pipeline_001",                                                                    â”‚    â”‚
â”‚  â”‚    "user_context": { "user_id": "user_001", "tenant_id": "tenant_001" } â”‚    â”‚
â”‚  â”‚  }                                                                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚                                            â”‚
â”‚                                     â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                       INGESTION WORKER                                   â”‚    â”‚
â”‚  â”‚                                                                          â”‚    â”‚
â”‚  â”‚  for each document_id:                                                   â”‚    â”‚
â”‚  â”‚    1. Call Parser Service    â†’ extracted_text                           â”‚    â”‚
â”‚  â”‚    2. Call Chunker Service   â†’ chunks (based on config)                 â”‚    â”‚
â”‚  â”‚    3. Call Embedder Service  â†’ vectors (based on config)                â”‚    â”‚
â”‚  â”‚    4. Call Indexer Service   â†’ index to Milvus/ES (based on config)     â”‚    â”‚
â”‚  â”‚    5. Update document status in PostgreSQL                              â”‚    â”‚
â”‚  â”‚                                                                          â”‚    â”‚
â”‚  â”‚  âš ï¸ NO queue between steps - sequential calls within worker             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                  â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                        RETRIEVAL QUEUE                                  â”‚    â”‚
â”‚  â”‚                                                                          â”‚    â”‚
â”‚  â”‚  Request Message:                                                        â”‚    â”‚
â”‚  â”‚  {                                                                       â”‚    â”‚
â”‚  â”‚    "job_id": "query_001",                                                â”‚    â”‚
â”‚  â”‚    "kb_id": "kb_001",                                                    â”‚    â”‚
â”‚  â”‚    "pipeline_config": {                                                  â”‚    â”‚
â”‚  â”‚      "search": { "type": "hybrid", "vector_weight": 0.6 },              â”‚    â”‚
â”‚  â”‚      "prompt_processing": { "methods": ["query_expansion"] },           â”‚    â”‚
â”‚  â”‚      "retrieval": { "top_k": 10 },                                       â”‚    â”‚
â”‚  â”‚      "reranking": { "enabled": true, "model": "bge-reranker-v2" },      â”‚    â”‚
â”‚  â”‚      "llm": { "model": "gpt-4", "temperature": 0.7 }                    â”‚    â”‚
â”‚  â”‚    },                                                                    â”‚    â”‚
â”‚  â”‚    "user_context": { "user_id": "user_001", "groups": ["finance"] }     â”‚    â”‚
â”‚  â”‚  }                                                                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚                                            â”‚
â”‚                                     â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                       RETRIEVAL WORKER                                   â”‚    â”‚
â”‚  â”‚                                                                          â”‚    â”‚
â”‚  â”‚  1. Call Query Processor  â†’ processed_query (based on config)           â”‚    â”‚
â”‚  â”‚  2. Call Embedder Service â†’ query_vector                                â”‚    â”‚
â”‚  â”‚  3. Call Searcher Service â†’ results (with permission filter)            â”‚    â”‚
â”‚  â”‚  4. Call Reranker Service â†’ reranked_results (if enabled)               â”‚    â”‚
â”‚  â”‚  5. Call LLM Service      â†’ generated_answer                            â”‚    â”‚
â”‚  â”‚  6. Return/Store response                                               â”‚    â”‚
â”‚  â”‚                                                                          â”‚    â”‚
â”‚  â”‚  âš ï¸ NO queue between steps - sequential calls within worker             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.4 Key Design Decisions

| Decision | Rationale |
|----------|-----------|
| **2 Queues only** | ÄÆ¡n giáº£n hÃ³a, má»—i pipeline cÃ³ 1 queue riÃªng |
| **Config in request** | Worker linh hoáº¡t, cÃ³ thá»ƒ xá»­ lÃ½ nhiá»u config khÃ¡c nhau |
| **Sequential service calls** | KhÃ´ng cáº§n queue giá»¯a cÃ¡c steps, giáº£m complexity |
| **Services stateless** | Dá»… scale, má»—i service lÃ m 1 viá»‡c duy nháº¥t |

  ---

  ## 4. Document Upload Flow

  ### 4.1 Design Decisions

  | Decision | Value | Rationale |
  |----------|-------|-----------|
  | **Uniqueness** | `kb_id + filename` | 1 file chá»‰ tá»“n táº¡i 1 láº§n trong 1 KB |
  | **ID Generation** | `hash(kb_id + ":" + filename)` | Deterministic, dá»… check conflict |
  | **Versioning** | KhÃ´ng cÃ³ | ÄÆ¡n giáº£n hÃ³a, user tá»± quáº£n lÃ½ |
  | **Delete** | Soft delete | Cho phÃ©p restore tá»« Trash UI |
  | **Cross-KB** | Cho phÃ©p | CÃ¹ng file cÃ³ thá»ƒ tá»“n táº¡i á»Ÿ nhiá»u KB (physical copy) |

  ### 4.2 Upload Flow Diagram

  ```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                           DOCUMENT UPLOAD FLOW                                   â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                                                                  â”‚
  â”‚  User Upload File(s)                                                            â”‚
  â”‚         â”‚                                                                        â”‚
  â”‚         â–¼                                                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚                      UPLOAD MIDDLEWARE SERVICE                           â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚         â”‚                                                                        â”‚
  â”‚         â–¼                                                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                            â”‚
  â”‚  â”‚ 1. Validation   â”‚ â”€â”€ Check file type, size, KB exists?                       â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                            â”‚
  â”‚           â”‚                                                                      â”‚
  â”‚           â–¼                                                                      â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                            â”‚
  â”‚  â”‚ 2. Generate ID  â”‚ â”€â”€ id = hash(kb_id + ":" + filename)                       â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                            â”‚
  â”‚           â”‚                                                                      â”‚
  â”‚           â–¼                                                                      â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                            â”‚
  â”‚  â”‚ 3. Check Exist  â”‚ â”€â”€ SELECT * FROM uploaded_documents WHERE id = ?           â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                            â”‚
  â”‚           â”‚                                                                      â”‚
  â”‚      â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
  â”‚      â”‚                         â”‚                                                â”‚
  â”‚   KhÃ´ng tá»“n táº¡i             ÄÃ£ tá»“n táº¡i                                          â”‚
  â”‚      â”‚                         â”‚                                                â”‚
  â”‚      â”‚                    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                                           â”‚
  â”‚      â”‚                    â”‚         â”‚                                           â”‚
  â”‚      â”‚               is_active   is_active                                      â”‚
  â”‚      â”‚                = TRUE     = FALSE                                        â”‚
  â”‚      â”‚                    â”‚         â”‚                                           â”‚
  â”‚      â–¼                    â–¼         â–¼                                           â”‚
  â”‚   CREATE              CONFLICT   REACTIVATE                                     â”‚
  â”‚      â”‚                    â”‚         â”‚                                           â”‚
  â”‚      â”‚              Return 409      â”‚                                           â”‚
  â”‚      â”‚              with options    â”‚                                           â”‚
  â”‚      â”‚                    â”‚         â”‚                                           â”‚
  â”‚      â–¼                    â–¼         â–¼                                           â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ 4. Store to MinIO + Save metadata to PostgreSQL                         â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚           â”‚                                                                      â”‚
  â”‚           â–¼                                                                      â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ 5. Push to INGESTION QUEUE                                               â”‚    â”‚
  â”‚  â”‚    {                                                                     â”‚    â”‚
  â”‚  â”‚      document_ids: ["doc_hash_1"],                                       â”‚    â”‚
  â”‚  â”‚      kb_id: "kb_001",                                                    â”‚    â”‚
  â”‚  â”‚      pipeline_config: { ... from KB's active ingestion pipeline }        â”‚    â”‚
  â”‚  â”‚    }                                                                     â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚           â”‚                                                                      â”‚
  â”‚           â–¼                                                                      â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ 6. INGESTION WORKER picks up job and processes sequentially             â”‚    â”‚
  â”‚  â”‚    â†’ Parser Service â†’ Chunker Service â†’ Embedder Service â†’ Indexer      â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                                                  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ```

  ### 4.3 Upload Case Handling

  | Case | Condition | Action |
  |------|-----------|--------|
  | **CREATE** | Document khÃ´ng tá»“n táº¡i | Táº¡o má»›i record + upload MinIO + push queue |
  | **CONFLICT** | Document tá»“n táº¡i, `is_active = TRUE` | Return 409 vá»›i options: SKIP / RENAME / REPLACE |
  | **REACTIVATE** | Document tá»“n táº¡i, `is_active = FALSE` | KÃ­ch hoáº¡t láº¡i + update content má»›i |

  ### 4.4 Conflict Resolution Options

  | Option | Action |
  |--------|--------|
  | **SKIP** | KhÃ´ng lÃ m gÃ¬, giá»¯ nguyÃªn file cÅ© |
  | **RENAME** | User Ä‘á»•i tÃªn file â†’ táº¡o ID má»›i â†’ retry as CREATE |
  | **REPLACE** | Ghi Ä‘Ã¨ content má»›i + delete chunks cÅ© + re-process |

  ### 4.5 Soft Delete & Restore

  ```
  SOFT DELETE:
  â€¢ Set is_active = FALSE
  â€¢ Set deleted_at = NOW()
  â€¢ KHÃ”NG xÃ³a record, KHÃ”NG xÃ³a file trong MinIO
  â€¢ Chunks Ä‘Ã¡nh dáº¥u is_active = FALSE

  RESTORE (tá»« Trash UI):
  â€¢ Set is_active = TRUE
  â€¢ KhÃ´ng cáº§n upload láº¡i (file váº«n cÃ²n trong MinIO)
  â€¢ Chunks Ä‘Æ°á»£c reactivate
  ```

---

## 5. Pipeline Configuration

### 5.1 Ingestion Pipeline Configuration

```json
{
  "parser": {
    "pdf": {
      "method": "pypdf",
      "lang": "Vietnamese",
      "output_format": "text"
    },
    "image": {
      "method": "vlm",
      "llm_id": "gpt-4-vision",
      "output_format": "text"
    },
    "audio": {
      "method": "whisper",
      "llm_id": "whisper-large-v3",
      "output_format": "text"
    },
    "document": {
      "method": "unstructured",
      "output_format": "text"
    },
    "spreadsheet": {
      "method": "pandas",
      "output_format": "json"
    },
    "code": {
      "method": "treesitter",
      "output_format": "ast"
    }
  },

  "chunker": {
    "text": {
      "method": "recursive_semantic",
      "chunk_size": 512,
      "chunk_overlap": 50,
      "separators": ["\n\n", "\n", ". ", " "],
      "length_function": "token_count",
      "preserve_metadata": true
    },
    "table": {
      "method": "row_group",
      "rows_per_chunk": 20,
      "include_header": true,
      "overlap_rows": 2,
      "preserve_structure": true,
      "output_format": "markdown_table"
    },
    "code": {
      "method": "ast_semantic",
      "granularity": "function",
      "max_chunk_size": 1000,
      "include_context": true,
      "preserve_imports": true
    },
    "mixed": {
      "method": "adaptive",
      "detect_boundaries": true,
      "fallback": "text"
    }
  },

  "embedding": {
    "text": {
      "model": "jinaai-v3",
      "base_url": "aiep_path",
      "dimension": 3072,
      "batch_size": 100,
      "max_tokens": 8191
    },
    "table": {
      "model": "embed-multilingual-v3.0",
      "base_url": "aiep_path",
      "dimension": 3072,
      "batch_size": 100,
      "max_tokens": 8191
    },
    "code": {
      "model": "voyage_code",
      "base_url": "aiep_path",
      "dimension": 3072,
      "batch_size": 100,
      "max_tokens": 8191
    }
  },

  "indexing": {
    "strategy": "multi_collection",
    "vector_db": {
      "type": "milvus",
      "collections": {
        "text": {
          "name": "kb_text",
          "index_type": "AUTOINDEX",
          "metric_type": "COSINE",
          "partition_key": "source_id"
        },
        "table": {
          "name": "kb_table",
          "index_type": "AUTOINDEX",
          "metric_type": "COSINE",
          "partition_key": "source_id"
        },
        "code": {
          "name": "kb_code",
          "index_type": "AUTOINDEX",
          "metric_type": "COSINE",
          "partition_key": "language"
        }
      }
    },
    "keyword_db": {
      "type": "elasticsearch",
      "indices": {
        "text": {
          "name": "kb_text_keyword",
          "analyzer": "vietnamese"
        },
        "table": {
          "name": "kb_table_keyword",
          "analyzer": "standard"
        },
        "code": {
          "name": "kb_code_keyword",
          "analyzer": "standard"
        }
      }
    }
  }
}
```

### 5.2 Retrieval Pipeline Configuration
**Hybrid search**
```json
{
  "retrieval_pipeline": {
    "name": "semantic-retrieval",
    "knowledge_base_id": "kb_001",

    "prompt_processing": {
      "enabled": false,
      "methods": []
    },

    "search": {
      "type": "semantic",
      "similarity_threshold": 0.2,
      "top_k": 10
    },

    "reranking": {
      "enabled": false,
      "model": "bge-reranker-v2",
      "base_url": "aiep_path",
      "top_k": 5
    },

    "llm": {
      "model": "gpt-4",
      "base_url": "aiep_path",
      "temperature": 0.7
    }
  }
}
```

**Semantic search**
```json
{
  "retrieval_pipeline": {
    "name": "semantic-retrieval",
    "knowledge_base_id": "kb_001",

    "prompt_processing": {
      "enabled": false,
      "methods": []
    },

    "search": {
      "type": "semantic",
      "similarity_threshold": 0.2,
      "top_k": 10
    },

    "reranking": {
      "enabled": false,
      "model": "bge-reranker-v2",
      "base_url": "aiep_path",
      "top_k": 5
    },

    "llm": {
      "model": "gpt-4",
      "base_url": "aiep_path",
      "temperature": 0.7
    }
  }
}
```

**Text search**
```json
{
  "retrieval_pipeline": {
    "name": "keyword-retrieval",
    "knowledge_base_id": "kb_001",

    "prompt_processing": {
      "enabled": false,
      "methods": []
    },

    "search": {
      "type": "keyword",
      "top_k": 10
    },

    "reranking": {
      "enabled": false,
      "model": "bge-reranker-v2",
      "base_url": "aiep_path",
      "top_k": 5
    },

    "llm": {
      "model": "gpt-4",
      "base_url": "aiep_path",
      "temperature": 0.7
    }
  }
}
```

---

## 6. Storage Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           STORAGE ARCHITECTURE                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  PostgreSQL                                                                    â”‚
â”‚  â”œâ”€â”€ User Management: tenants, users, roles, groups, audit_logs                â”‚
â”‚  â”œâ”€â”€ RAG Data: knowledge_bases, uploaded_documents, chunks                     â”‚
â”‚  â””â”€â”€ Pipeline Config: ingestion_pipelines, retrieval_pipelines, pipeline_runs  â”‚
â”‚                                                                                  â”‚
â”‚  Milvus (Vector Search)                                                         â”‚
â”‚  â””â”€â”€ chunk_id, embedding, document_id, is_active, permissions                  â”‚
â”‚                                                                                  â”‚
â”‚  Elasticsearch (Fulltext Search)                                                â”‚
â”‚  â””â”€â”€ chunk_id, content, document_id, is_active, permissions                    â”‚
â”‚                                                                                  â”‚
â”‚  MinIO (File Storage) - tenant lÃ  optional                                      â”‚
â”‚  â””â”€â”€ rag-storage/{tenant_id}/{kb_id}/documents/{doc_id_hash}.{ext}             â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. Data Models & Database Schema

### 7.1 User Management Tables

```sql
-- Tenants
CREATE TABLE tenants (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    slug VARCHAR(100) NOT NULL UNIQUE,
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT NOW()
);

-- Users
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    email VARCHAR(255) NOT NULL,
    password_hash VARCHAR(255),
    full_name VARCHAR(255) NOT NULL,
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT NOW(),
    CONSTRAINT unique_email_per_tenant UNIQUE(tenant_id, email)
);

-- Roles & Groups (simplified)
CREATE TABLE roles (
    id UUID PRIMARY KEY,
    tenant_id UUID REFERENCES tenants(id),
    name VARCHAR(100) NOT NULL,
    permissions JSONB NOT NULL DEFAULT '{}'
);

CREATE TABLE user_roles (
    user_id UUID REFERENCES users(id),
    role_id UUID REFERENCES roles(id),
    scope_type VARCHAR(50),
    scope_id UUID,
    PRIMARY KEY (user_id, role_id, scope_type, scope_id)
);

CREATE TABLE groups (
    id UUID PRIMARY KEY,
    tenant_id UUID REFERENCES tenants(id),
    name VARCHAR(255) NOT NULL
);

CREATE TABLE user_groups (
    user_id UUID REFERENCES users(id),
    group_id UUID REFERENCES groups(id),
    PRIMARY KEY (user_id, group_id)
);
```

### 7.2 RAG Data Tables

```sql
-- Knowledge Bases
CREATE TABLE knowledge_bases (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    name VARCHAR(255) NOT NULL,
    permission_type VARCHAR(20) DEFAULT 'private',
    owner_id UUID NOT NULL REFERENCES users(id),
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT NOW()
);

-- Uploaded Documents (No Versioning, Soft Delete)
CREATE TABLE uploaded_documents (
    id VARCHAR(64) PRIMARY KEY,  -- hash(kb_id + ":" + filename)
    kb_id UUID NOT NULL REFERENCES knowledge_bases(id),
    filename VARCHAR(500) NOT NULL,
    minio_path VARCHAR(1000) NOT NULL,
    content_type VARCHAR(50) NOT NULL,
    file_size_bytes BIGINT,
    content_hash VARCHAR(64),
    
    permission_type VARCHAR(20) DEFAULT 'inherit',
    owner_id UUID NOT NULL REFERENCES users(id),
    
    is_active BOOLEAN DEFAULT TRUE,
    deleted_at TIMESTAMP,
    deleted_by UUID,
    
    status VARCHAR(20) DEFAULT 'pending',
    chunk_count INT DEFAULT 0,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    CONSTRAINT unique_filename_per_kb UNIQUE(kb_id, filename)
);

-- Chunks
CREATE TABLE chunks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    document_id VARCHAR(64) REFERENCES uploaded_documents(id),
    kb_id UUID NOT NULL,
    content TEXT NOT NULL,
    chunk_index INT NOT NULL,
    
    owner_id UUID NOT NULL,
    is_public BOOLEAN DEFAULT FALSE,
    allowed_user_ids UUID[] DEFAULT '{}',
    allowed_group_ids UUID[] DEFAULT '{}',

    -- check document is activated 
    is_active BOOLEAN DEFAULT TRUE, 
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 7.3 Pipeline Tables

```sql
-- Ingestion Pipelines
CREATE TABLE ingestion_pipelines (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    kb_id UUID NOT NULL REFERENCES knowledge_bases(id),
    name VARCHAR(255) NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    
    chunking_strategy VARCHAR(50) NOT NULL,
    chunk_size INT DEFAULT 512,
    chunk_overlap INT DEFAULT 50,
    embedding_model VARCHAR(50) NOT NULL,
    indexing_method VARCHAR(50) DEFAULT 'auto',
    target_milvus BOOLEAN DEFAULT TRUE,
    target_elasticsearch BOOLEAN DEFAULT TRUE,
    
    full_config JSONB,  -- Complete config for queue message
    
    created_at TIMESTAMP DEFAULT NOW()
);

-- Retrieval Pipelines
CREATE TABLE retrieval_pipelines (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    kb_id UUID NOT NULL REFERENCES knowledge_bases(id),
    name VARCHAR(255) NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    
    search_type VARCHAR(20) NOT NULL,
    vector_weight DECIMAL(3,2) DEFAULT 0.6,
    top_k INT DEFAULT 10,
    reranking_enabled BOOLEAN DEFAULT FALSE,
    reranking_model VARCHAR(50),
    llm_model VARCHAR(50) NOT NULL,
    
    full_config JSONB,  -- Complete config for queue message
    
    created_at TIMESTAMP DEFAULT NOW()
);

-- Pipeline Runs (Job Tracking)
CREATE TABLE pipeline_runs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    job_id VARCHAR(100) UNIQUE NOT NULL,
    pipeline_type VARCHAR(20) NOT NULL,  -- 'ingestion' or 'retrieval'
    pipeline_id UUID NOT NULL,
    kb_id UUID REFERENCES knowledge_bases(id),
    
    document_ids VARCHAR(64)[],  -- For ingestion
    query TEXT,                   -- For retrieval
    pipeline_config JSONB,        -- Config snapshot
    
    status VARCHAR(20) DEFAULT 'pending',
    total_items INT,
    processed_items INT DEFAULT 0,
    
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    result JSONB,
    error_message TEXT,
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

## 8. Ingestion Pipeline Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         INGESTION PIPELINE FLOW                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  User Config (6 Steps) â†’ Upload Middleware â†’ INGESTION QUEUE â†’ INGESTION WORKER â”‚
â”‚                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                       INGESTION WORKER                                   â”‚    â”‚
â”‚  â”‚                                                                          â”‚    â”‚
â”‚  â”‚  For each document in request:                                          â”‚    â”‚
â”‚  â”‚                                                                          â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚  â”‚  â”‚   Parser    â”‚â”€â”€â”€â–¶â”‚   Chunker   â”‚â”€â”€â”€â–¶â”‚  Embedder   â”‚â”€â”€â”€â–¶â”‚  Indexer  â”‚ â”‚    â”‚
â”‚  â”‚  â”‚   Service   â”‚    â”‚   Service   â”‚    â”‚   Service   â”‚    â”‚  Service  â”‚ â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚  â”‚        â”‚                  â”‚                  â”‚                  â”‚        â”‚    â”‚
â”‚  â”‚        â–¼                  â–¼                  â–¼                  â–¼        â”‚    â”‚
â”‚  â”‚   Read MinIO       Save chunks to      Generate vectors   Index to      â”‚    â”‚
â”‚  â”‚   Extract text     PostgreSQL          (batch)            Milvus + ES   â”‚    â”‚
â”‚  â”‚                                                                          â”‚    â”‚
â”‚  â”‚  âš ï¸ Sequential calls - NO queue between services                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 9. Retrieval Pipeline Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         RETRIEVAL PIPELINE FLOW                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  Query Request â†’ Query Service  â†’ RETRIEVAL WORKER                              â”‚
â”‚                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                       RETRIEVAL WORKER                                   â”‚    â”‚
â”‚  â”‚                                                                          â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚    â”‚
â”‚  â”‚  â”‚  Query    â”‚â”€â”€â–¶â”‚  Embedder â”‚â”€â”€â–¶â”‚  Searcher â”‚â”€â”€â–¶â”‚  Reranker â”‚â”€â”€â–¶ LLM  â”‚    â”‚
â”‚  â”‚  â”‚ Processor â”‚   â”‚  Service  â”‚   â”‚  Service  â”‚   â”‚  Service  â”‚         â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚    â”‚
â”‚  â”‚        â”‚               â”‚               â”‚               â”‚                â”‚    â”‚
â”‚  â”‚        â–¼               â–¼               â–¼               â–¼                â”‚    â”‚
â”‚  â”‚   Process query   Query vector   Search Milvus    Rerank results       â”‚    â”‚
â”‚  â”‚   (expansion,                    + Elasticsearch  (if enabled)         â”‚    â”‚
â”‚  â”‚    rewrite)                      + RRF fusion                          â”‚    â”‚
â”‚  â”‚                                  + Permission filter                   â”‚    â”‚
â”‚  â”‚                                  + is_active filter                    â”‚    â”‚
â”‚  â”‚                                                                          â”‚    â”‚
â”‚  â”‚  âš ï¸ Sequential calls - NO queue between services                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 10. Permission Model

### 10.1 Roles

| Role | Permissions |
|------|-------------|
| **Admin** | Manage tenants, users, system settings |
| **KB Builder** | Configure pipelines, upload/delete documents, create/delete KBs |
| **General user** | Query on built KB |

### 10.2 Query-Time Filter

**âœ… Confirm Permission Logic**

#### KB Level

| Aspect | Rule |
|--------|------|
| **Ai Ä‘Æ°á»£c sá»­a KB** | Chá»‰ KB owner (upload, delete, config pipeline) |
| **Ai Ä‘Æ°á»£c query** | Users/Groups Ä‘Æ°á»£c cáº¥p quyá»n |
| **Visibility** | KB khÃ´ng hiá»ƒn thá»‹ vá»›i user khÃ´ng cÃ³ quyá»n |

#### Document Level (Inherit)

| Document permission_type | Behavior |
|--------------------------|----------|
| **public** (default) | Káº¿ thá»«a tá»« KB â†’ ai access Ä‘Æ°á»£c KB thÃ¬ query Ä‘Æ°á»£c document |
| **private** | Override â†’ chá»‰ document owner |
| **custom** | Override â†’ chá»‰ users/groups Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh |

---

### ğŸ”„ Permission Filter Flow (ÄÆ¡n giáº£n hÃ³a)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PERMISSION FILTERING FLOW                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  User Query: "What was Q3 revenue?" to KB "finance-reports"                     â”‚
â”‚         â”‚                                                                        â”‚
â”‚         â–¼                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  LAYER 1: KB Permission Check (API Level)                                â”‚    â”‚
â”‚  â”‚                                                                          â”‚    â”‚
â”‚  â”‚  Check: User cÃ³ quyá»n access KB khÃ´ng?                                  â”‚    â”‚
â”‚  â”‚                                                                          â”‚    â”‚
â”‚  â”‚  KB.permission_type = 'public'  â†’ Táº¥t cáº£ user trong tenant OK           â”‚    â”‚
â”‚  â”‚  KB.permission_type = 'private' â†’ Chá»‰ KB owner OK                       â”‚    â”‚
â”‚  â”‚  KB.permission_type = 'custom'  â†’ Check kb_access table                 â”‚    â”‚
â”‚  â”‚                                                                          â”‚    â”‚
â”‚  â”‚  âŒ KhÃ´ng cÃ³ quyá»n â†’ 403 Forbidden (KB khÃ´ng hiá»ƒn thá»‹)                  â”‚    â”‚
â”‚  â”‚  âœ… CÃ³ quyá»n â†’ Tiáº¿p tá»¥c Layer 2                                         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â”‚                                                                        â”‚
â”‚         â–¼                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  LAYER 2: Document Filter (Search Level - Milvus/ES)                    â”‚    â”‚
â”‚  â”‚                                                                          â”‚    â”‚
â”‚  â”‚  Filter:                                                                â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚  MUST: is_active = TRUE                                           â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚                          AND                                            â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚  Document Permission (at least one):                              â”‚  â”‚    â”‚
â”‚  â”‚  â”‚                                                                   â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â€¢ permission_type = 'public'  â†’ OK (Ä‘Ã£ pass KB check)           â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â€¢ permission_type = 'private'  â†’ owner_id = current_user        â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â€¢ permission_type = 'custom'   â†’ user in allowed_users/groups   â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â”‚                                                                        â”‚
â”‚         â–¼                                                                        â”‚
â”‚  Search Results                                                                 â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
---

## 11. API Design

### 11.1 Document APIs

```yaml
POST   /api/v1/knowledge-bases/{kb_id}/documents/upload
POST   /api/v1/knowledge-bases/{kb_id}/documents/upload/resolve
GET    /api/v1/knowledge-bases/{kb_id}/documents
DELETE /api/v1/documents/{id}

# Trash
GET    /api/v1/knowledge-bases/{kb_id}/trash
POST   /api/v1/knowledge-bases/{kb_id}/trash/restore
```

### 11.2 Query APIs

```yaml
# Sync
POST   /api/v1/knowledge-bases/{kb_id}/query

# Async
POST   /api/v1/knowledge-bases/{kb_id}/query/async
GET    /api/v1/jobs/{job_id}
```

---

## 12. Technology Stack

| Component | Technology |
|-----------|------------|
| **API** | FastAPI |
| **Database** | PostgreSQL 15+ |
| **Vector DB** | Milvus 2.3+ |
| **Search** | Elasticsearch 8.x |
| **Storage** | MinIO |
| **Queue** | Redis 7+ |
| **Workers** | Celery |

---

## 13. Deployment Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        KUBERNETES DEPLOYMENT                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  Ingress (NGINX)                                                                â”‚
â”‚       â”‚                                                                          â”‚
â”‚       â–¼                                                                          â”‚
â”‚  API Services                                                                   â”‚
â”‚  â”œâ”€â”€ Upload Middleware (replicas: 3)                                           â”‚
â”‚  â”œâ”€â”€ Query Service (replicas: 3)                                               â”‚
â”‚  â””â”€â”€ Management Service (replicas: 2)                                          â”‚
â”‚       â”‚                                                                          â”‚
â”‚       â–¼                                                                          â”‚
â”‚  Workers (HPA)                                                                  â”‚
â”‚  â”œâ”€â”€ Ingestion Workers (min: 2, max: 20)                                       â”‚
â”‚  â””â”€â”€ Retrieval Workers (min: 2, max: 10)                                       â”‚
â”‚       â”‚                                                                          â”‚
â”‚       â–¼                                                                          â”‚
â”‚  Processing Services                                                            â”‚
â”‚  â”œâ”€â”€ Parser, Chunker, Embedder, Indexer                                        â”‚
â”‚  â””â”€â”€ Query Processor, Searcher, Reranker, LLM                                  â”‚
â”‚       â”‚                                                                          â”‚
â”‚       â–¼                                                                          â”‚
â”‚  Data Layer (StatefulSets)                                                      â”‚
â”‚  â””â”€â”€ PostgreSQL, Milvus, Elasticsearch, MinIO, Redis                           â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 14. Implementation Roadmap

| Phase | Duration | Deliverables |
|-------|----------|--------------|
| **1. Foundation** | Week 1-2 | PostgreSQL schema, Auth, API structure, Redis queues |
| **2. Services** | Week 3-4 | Parser, Chunker, Embedder, Indexer services |
| **3. Ingestion** | Week 5-6 | Upload middleware, Ingestion Worker, conflict handling |
| **4. Retrieval** | Week 7-8 | Searcher, Reranker, LLM services, Retrieval Worker |
| **5. Production** | Week 9-10 | UI, monitoring, testing, documentation |

**Total: 10 weeks**

---

*Document Version: 4.1.0*  
*Last Updated: 2025-01-27*

theÃª model adapter
agent response -> kÃªt noá»‘ voá»›voiwcÃ¡c module